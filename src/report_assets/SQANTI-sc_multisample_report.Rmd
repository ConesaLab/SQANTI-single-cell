---
title: "SQANTI-single cell multi-sample `r if (exists('mode') && mode == 'isoforms') 'isoforms' else 'reads'` report"
date: "`r paste0('Date: ', format(Sys.time(), '%d %B %Y'))`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    number_sections: false
    css: style-multisample.css
    theme:
      version: 3
      bootswatch: flatly
    highlight: tango
    self_contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(plotly)
library(dplyr)
library(htmltools)

prepare_plot <- function(p, width = 1000, height = 600, responsive = FALSE,
                         title_pad = NULL, margin = NULL) {
  if (is.null(p) || !inherits(p, "htmlwidget")) {
    return(p)
  }

  `%||%` <- function(a, b) if (is.null(a)) b else a

  standard_margin <- list(t = 80, b = 120, l = 100, r = 80)
  legend_defaults <- list(
    orientation = "h",
    x = 0.5,
    xanchor = "center",
    y = -0.25,
    yanchor = "top",
    bgcolor = "rgba(0,0,0,0)",
    bordercolor = "rgba(0,0,0,0)"
  )
  title_pad_defaults <- list(l = 0, r = 0, t = 12, b = 12)
  axis_tickfont_defaults <- list(size = 14)
  axis_title_defaults <- list(standoff = 12)
  axis_title_font_defaults <- list(size = 16)

  final_margin <- standard_margin
  if (!is.null(margin)) {
    final_margin <- utils::modifyList(final_margin, margin)
  }
  p <- plotly::layout(p, width = width, height = height)
  p$x$layout$margin <- final_margin

  title_entry <- p$x$layout$title %||% list()
  title_entry$pad <- utils::modifyList(title_pad_defaults, title_entry$pad %||% list())
  if (!is.null(title_pad)) {
    title_entry$pad <- utils::modifyList(title_entry$pad, title_pad)
  }
  p$x$layout$title <- title_entry

  existing_legend <- p$x$layout$legend %||% list()
  legend_entry <- utils::modifyList(existing_legend, legend_defaults)
  if (is.null(existing_legend$title) || is.null(existing_legend$title$text)) {
    legend_entry$title <- utils::modifyList(legend_entry$title %||% list(), list(text = ""))
  }
  legend_entry$font <- utils::modifyList(legend_entry$font %||% list(), list(size = 14))
  p$x$layout$legend <- legend_entry

  axis_names <- names(p$x$layout)
  axis_names <- axis_names[grepl("^[xy]axis(\\d+)?$", axis_names)]
  for (axis_name in axis_names) {
    axis_entry <- p$x$layout[[axis_name]] %||% list()
    axis_entry$automargin <- TRUE
    axis_entry$tickfont <- utils::modifyList(axis_entry$tickfont %||% list(), axis_tickfont_defaults)
    axis_entry$title <- utils::modifyList(axis_entry$title %||% list(), axis_title_defaults)
    axis_entry$title$font <- utils::modifyList(axis_entry$title$font %||% list(), axis_title_font_defaults)
    p$x$layout[[axis_name]] <- axis_entry
  }

  plotly::config(p, displaylogo = FALSE, responsive = responsive)
}
```


# Samples Per-Cell Summary

```{r summary-table}
if (exists("multi_summary_tbl_html", envir = .GlobalEnv)) {
  summary_tbl <- get("multi_summary_tbl_html", envir = .GlobalEnv)
  knitr::kable(summary_tbl, format = "html", escape = FALSE, align = "c")
} else {
  cat("No Samples Per-Cell Summary table available.")
}
```

# Samples `r entity_label_plural` Distributions per Structural Category {.tabset .tabset-fade}

## Samples Comparison {.tabset}

```{r structural-per-category, results='asis'}
if (exists("multi_structural_category_violin_plots", envir = .GlobalEnv)) {
  plot_list <- get("multi_structural_category_violin_plots", envir = .GlobalEnv)
  
  if (length(plot_list) > 0) {
    # Define category order
    category_order <- c("FSM", "ISM", "NIC", "NNC", "Genic Genomic", "Antisense", "Fusion", "Intergenic", "Genic Intron")
    # Sort list by category order if possible
    matched <- match(category_order, names(plot_list))
    # Filter and reorder, keep only those that exist
    plot_list <- plot_list[na.omit(matched)]
    
    # Create tabs for each category
    for (name in names(plot_list)) {
      cat('\n### ', name, '\n')
      print(plot_list[[name]])
      cat('\n')
    }
  } else {
    cat("No per-category structural plots available.")
  }
} else {
  cat("No per-category structural plots available.")
}
```

```{=html}
<div class="section-spacer-xl"></div>
```

# PCA Analysis {.tabset .tabset-fade}

## PCA Plot

<div id="pca-scores" class="pca-pane">

```{r pca-scores}
if (exists("multi_pca_scores_plot_html", envir = .GlobalEnv)) {
  prepare_plot(
    get("multi_pca_scores_plot_html", envir = .GlobalEnv),
    width = 800, height = 660,
    margin = list(t = 100),
    title_pad = list(b = 16)
  )
} else if (exists("multi_pca_scores_plot", envir = .GlobalEnv)) {
  plt <- get("multi_pca_scores_plot", envir = .GlobalEnv)
  prepare_plot(
    plotly::ggplotly(plt, tooltip = c("x", "y", "colour", "label")),
    width = 800, height = 660,
    margin = list(t = 100),
    title_pad = list(b = 16)
  )
} else {
  cat("PCA score plot is not available.")
}
```

</div>

## Scree Plot

<div id="pca-scree" class="pca-pane">

```{r pca-scree}
if (exists("multi_pca_scree_plot_html", envir = .GlobalEnv)) {
  prepare_plot(
    get("multi_pca_scree_plot_html", envir = .GlobalEnv),
    margin = list(t = 100),
    title_pad = list(b = 6)
  )
} else if (exists("multi_pca_scree_plot", envir = .GlobalEnv)) {
  plt <- get("multi_pca_scree_plot", envir = .GlobalEnv)
  prepare_plot(
    plotly::ggplotly(plt, tooltip = c("x", "y")),
    margin = list(t = 100),
    title_pad = list(b = 6)
  )
} else {
  cat("PCA scree plot is not available.")
}
```

</div>

## Top 10 loadings by component {.tabset}

<div id="pca-loadings" class="pca-pane">

```{r pca-loadings, results='asis'}
# Print Loadings (PC1 / PC2)
if (exists("multi_pca_top_loadings_plots", envir = .GlobalEnv)) {
  loadings_plots <- get("multi_pca_top_loadings_plots", envir = .GlobalEnv)
  for (name in names(loadings_plots)) {
    cat('\n### ', name, ' Loadings\n')
    print(loadings_plots[[name]])
    cat('\n')
  }
}

# Print Feature Distributions
if (exists("multi_pca_loading_distribution_plots", envir = .GlobalEnv)) {
  feature_plots <- get("multi_pca_loading_distribution_plots", envir = .GlobalEnv)
  if (length(feature_plots) > 0) {
    for (name in names(feature_plots)) {
      cat('\n### ', name, '\n')
      print(feature_plots[[name]])
      cat('\n')
    }
  }
}
```

</div>

```{r pca-feature-dists, include=FALSE}
NULL
```

